<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Curator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        .pulse-dot {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        .chat-container {
            height: calc(100vh - 140px);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">ðŸŽµ AI Music Curator</h1>
            <div class="text-sm text-gray-600">
                User ID: <span id="userId" class="font-mono bg-gray-100 px-2 py-1 rounded">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Main Chat Area -->
    <main class="max-w-4xl mx-auto p-4">
        <div id="chatContainer" class="chat-container overflow-y-auto bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
            <div id="chatMessages" class="space-y-4">
                <!-- Messages will be dynamically added here -->
            </div>
            
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="hidden flex items-center space-x-2 text-gray-500 mt-4">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-blue-500 rounded-full pulse-dot"></div>
                    <div class="w-2 h-2 bg-blue-500 rounded-full pulse-dot" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-blue-500 rounded-full pulse-dot" style="animation-delay: 0.4s;"></div>
                </div>
                <span>AI is curating music for you...</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="flex space-x-2">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Tell me about your music preferences..." 
                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                onkeypress="handleKeyPress(event)"
            >
            <button 
                id="sendButton"
                onclick="sendMessage()" 
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
            >
                Send
            </button>
        </div>
    </main>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-semibold text-red-600 mb-2">Error</h3>
            <p id="errorMessage" class="text-gray-700 mb-4"></p>
            <button onclick="closeErrorModal()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                Close
            </button>
        </div>
    </div>

    <script>
        // Firebase configuration - Replace with your actual config
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let chatHistory = [];
        let currentUser = null;
        const __app_id = 'music-curator-app'; // Replace with actual app ID
        const __initial_auth_token = null; // Replace with actual token if available

        // System prompt for the AI music curator
        const systemPrompt = {
            role: 'system',
            content: 'You are a friendly music curator. When users ask for music recommendations, respond with a numbered list of at least 5 songs with the title and artist. Do not include any conversational text before or after the list. Format: 1. "Song Title" by Artist Name'
        };

        // Initialize chat history with system prompt
        chatHistory.push(systemPrompt);

        // Authentication and initialization
        async function initializeApp() {
            try {
                // Authenticate user
                if (__initial_auth_token) {
                    // Use provided token (implementation depends on your auth setup)
                    console.log('Using initial auth token');
                } else {
                    await auth.signInAnonymously();
                }

                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('userId').textContent = user.uid.substring(0, 8) + '...';
                        loadChatHistory();
                    }
                });

            } catch (error) {
                showError('Authentication failed: ' + error.message);
            }
        }

        // Load chat history from Firestore
        async function loadChatHistory() {
            try {
                const docRef = db.collection('artifacts').doc(__app_id)
                    .collection('users').doc(currentUser.uid)
                    .collection('chat_history').doc('main');

                // Set up real-time listener
                docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.history) {
                            chatHistory = JSON.parse(data.history);
                            renderChatHistory();
                        }
                    } else {
                        // Initialize with system prompt if no history exists
                        saveChatHistory();
                    }
                });

            } catch (error) {
                showError('Failed to load chat history: ' + error.message);
            }
        }

        // Save chat history to Firestore
        async function saveChatHistory() {
            try {
                const docRef = db.collection('artifacts').doc(__app_id)
                    .collection('users').doc(currentUser.uid)
                    .collection('chat_history').doc('main');

                await docRef.set({
                    history: JSON.stringify(chatHistory),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

            } catch (error) {
                showError('Failed to save chat history: ' + error.message);
            }
        }

        // Render chat history in the UI
        function renderChatHistory() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            // Skip system prompt when rendering
            const userMessages = chatHistory.filter(msg => msg.role !== 'system');

            userMessages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = message.role === 'user' 
                    ? 'flex justify-end' 
                    : 'flex justify-start';

                const messageBubble = document.createElement('div');
                messageBubble.className = message.role === 'user'
                    ? 'bg-blue-600 text-white px-4 py-2 rounded-lg max-w-xs lg:max-w-md'
                    : 'bg-gray-200 text-gray-800 px-4 py-2 rounded-lg max-w-xs lg:max-w-md';

                messageBubble.innerHTML = formatMessage(message.content);
                messageDiv.appendChild(messageBubble);
                chatMessages.appendChild(messageDiv);
            });

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Format message content (convert numbered lists to proper HTML)
        function formatMessage(content) {
            // Convert numbered lists to HTML
            const lines = content.split('\n');
            let formattedContent = '';
            let inList = false;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (/^\d+\./.test(trimmedLine)) {
                    if (!inList) {
                        formattedContent += '<ol class="list-decimal list-inside space-y-1 mt-2">';
                        inList = true;
                    }
                    formattedContent += `<li>${trimmedLine.replace(/^\d+\.\s*/, '')}</li>`;
                } else {
                    if (inList) {
                        formattedContent += '</ol>';
                        inList = false;
                    }
                    if (trimmedLine) {
                        formattedContent += `<p>${trimmedLine}</p>`;
                    }
                }
            });

            if (inList) {
                formattedContent += '</ol>';
            }

            return formattedContent || content;
        }

        // Send message to AI
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to chat
            chatHistory.push({ role: 'user', content: message });
            input.value = '';
            renderChatHistory();
            saveChatHistory();

            // Show loading indicator
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('sendButton').disabled = true;

            try {
                // Call Gemini API
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=YOUR_GEMINI_API_KEY', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: chatHistory.map(msg => ({
                            role: msg.role === 'system' ? 'user' : msg.role,
                            parts: [{ text: msg.content }]
                        }))
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;

                // Add AI response to chat
                chatHistory.push({ role: 'assistant', content: aiResponse });
                renderChatHistory();
                saveChatHistory();

            } catch (error) {
                showError('Failed to get AI response: ' + error.message);
            } finally {
                // Hide loading indicator
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('sendButton').disabled = false;
            }
        }

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Error handling
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        // Initialize the app when page loads
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
